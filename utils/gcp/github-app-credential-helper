#!/bin/bash

set -e

GITHUB_APP_ID="1164867"
INSTALLATION_ID="62012633"

# Fetch the private key securely
PRIVATE_KEY=$(gcloud secrets versions access latest --secret=github-app-private-key)

# Generate a JWT
jwt=$(python3 -c "
import jwt
import time

private_key = '''$PRIVATE_KEY'''

payload = {
    'iat': int(time.time()),
    'exp': int(time.time()) + 600,
    'iss': $GITHUB_APP_ID
}

token = jwt.encode(payload, private_key, algorithm='RS256')
print(token)
")

# Get installation token
token_response=$(curl -s -X POST \
  -H "Authorization: Bearer $jwt" \
  -H "Accept: application/vnd.github.v3+json" \
  https://api.github.com/app/installations/$INSTALLATION_ID/access_tokens)

GITHUB_TOKEN=$(echo "$token_response" | jq -r .token)

# Respond to Git's credential request
while read -r line; do
  case "$line" in
    protocol=*)
      PROTOCOL="${line#protocol=}"
      ;;
    host=*)
      HOST="${line#host=}"
      ;;
  esac
done

if [[ "$HOST" == "github.com" ]]; then
  echo "username=x-access-token"
  echo "password=$GITHUB_TOKEN"
fi

